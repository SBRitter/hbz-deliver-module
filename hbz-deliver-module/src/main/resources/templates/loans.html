<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org">
<head>
<title>loans for patron</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<script src="http://code.jquery.com/jquery-latest.js"></script>
<link
	th:href="@{http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css}"
	rel="stylesheet" />

</head>
<body>
	<div class="container">
		<div class="jumbotron">
			<h2>loan list</h2>
		</div>
		<div class="page-header">
			<div class="row">
				<div class="col-md-6">
					<div class="input-group">
						<input type="text" class="form-control" id="patronId" placeholder="enter patron id" />
						<span class="input-group-btn">
							<button class="btn btn-primary" type="button" id="getLoansButton">get
								loans!</button>
						</span>
					</div>
				</div>
				<div class="col-md-6"></div>
				<div class="col-md-12">
					<br />
					 <div class="alert alert-info" role="alert" id="result"
						style="display: none;"></div>
					<div class="alert alert-danger" role="alert" id="alert"
						style="display: none;"></div>
					<br />
					<table class="table"></table>
				</div>
			</div>
		</div>
	</div>
	<script th:inline="javascript" type="text/javascript">
		/*<![CDATA[*/
		$(document).ready(function() {
			$('#getLoansButton').click(function() {
				$.get("/deliver/loans/" + $('#patronId').val(), function(data) {
					$('#alert').hide();
					$('.table').empty();
					if (data.startsWith("Error")) {
						$('#alert').text(data);
						$('#alert').fadeIn(500);
					} else {
						var loanArray = $.parseJSON(data);
						var tr;
						tr = $('<tr/>');
						tr.append("<th>loan id</th>");
						tr.append("<th>item id</th>");
						tr.append("<th>title</th>");
						tr.append("<th>actions</th>");
						$('table').append(tr);
						for (var i = 0; i < loanArray.length; i++) {
							tr = $('<tr/>');
							tr.append("<td>" + loanArray[i]._id + "</td>");
							tr.append("<td>" + loanArray[i].item_id + "</td>");
							tr.append("<td>" + loanArray[i].title + "</td>");
							tr.append("<td><button type='button' class='btn btn-primary return-button'>return</button></td>");
							$('table').append(tr);
						}
					}
					$('.return-button').click(function() {
						var returnJson = new Object();
						returnJson.patron = $('#patronId').val();
						var thisRow = $(this).closest("tr");
						returnJson.loan = thisRow.find("td").eq(0).text();
						var returnString = JSON.stringify(returnJson);
						$.post("/deliver/return", returnString, function(data) {
							// todo: only remove row if return was successful!
							thisRow.remove();
							$('#result').text(data);
							$('#result').fadeIn(500);
						});
					});
				});
				$('.btn').click(function() {
					$('#result').hide();
				});
			})
		});
		/*]]>*/
	</script>

</body>
</html>